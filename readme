# ============================
# ðŸ“š CONTEXTE & ARCHI DU PROJET
# ============================
# Objectif : API FastAPI qui expose un modÃ¨le ML (RandomForest scikit-learn) pour prÃ©dire le prix des maisons.
# Relations :
# - scikit-learn : entraÃ®ne/sÃ©rialise le modÃ¨le (.pkl) + StandardScaler (.pkl)
# - FastAPI + Uvicorn : sert une API REST (/predict, /health, /version, /metrics)
# - Prometheus : scrappe /metrics (compteurs et horodatages)
# - Grafana : visualise les mÃ©triques Prometheus (dashboards)
# - Docker : encapsule API et stack dâ€™observabilitÃ© pour dÃ©ploiement
# - Git LFS : stocke proprement les artefacts lourds (.pkl)
# - GitHub Actions : CI (tests) & intÃ©gration (stack up + checks)

# ============================
# ðŸ”§ INSTALLATION LOCALE (Python)
# ============================
# CrÃ©e lâ€™environnement Python et installe les deps
conda create -n ml_env python=3.11 -y
conda activate ml_env
pip install -r requirements.txt

# Active Git LFS pour suivre les modÃ¨les
git lfs install
git lfs track "*.pkl"

# GÃ¨le les versions (optionnel, pour reproductibilitÃ©)
pip freeze > requirements.txt

# ============================
# ðŸ§  ENTRAÃŽNEMENT & Ã‰VALUATION ML
# ============================
# EntraÃ®ne le modÃ¨le et sauvegarde :
python src/train_model.py
# Ã‰value, peut Ã©chouer si perf < seuil (Ã  configurer dans le script) :
python src/evaluate_model.py

# RÃ©sultat attendu : modÃ¨les dans ./models/
#  - models/random_forest.pkl
#  - models/scaler.pkl

# ============================
# ðŸš€ LANCER Lâ€™API EN LOCAL
# ============================
# Sert lâ€™API (auto-reload dev)
uvicorn src.api:app --reload

# VÃ©rifications rapides :
# - Docs Swagger :      http://127.0.0.1:8000/docs
# - Healthcheck :       http://127.0.0.1:8000/health
# - Version modÃ¨le :    http://127.0.0.1:8000/version
# - MÃ©triques Prom :    http://127.0.0.1:8000/metrics

# ============================
# ðŸ”® REQUÃŠTES DE PRÃ‰DICTION (curl)
# ============================
curl -X POST http://127.0.0.1:8000/predict \
  -H "Content-Type: application/json" \
  -d '{"MedInc":5,"HouseAge":20,"AveRooms":6,"AveBedrms":1,"Population":1000,"AveOccup":3,"Latitude":34,"Longitude":-118}'

# ============================
# ðŸ”® REQUÃŠTES DE PRÃ‰DICTION (PowerShell)
# ============================
# (utile sous Windows)
Invoke-WebRequest -Uri "http://127.0.0.1:8000/predict" `
  -Method POST `
  -Headers @{ "Content-Type" = "application/json" } `
  -Body '{"MedInc":5,"HouseAge":20,"AveRooms":6,"AveBedrms":1,"Population":1000,"AveOccup":3,"Latitude":34,"Longitude":-118}'

# ============================
# ðŸ“¦ DOCKER (API SEULE)
# ============================
# Construit lâ€™image API
docker build -t ml-housing-api .
# Lance le conteneur API (map port 8000)
docker run -p 8000:8000 ml-housing-api

# ============================
# ðŸ§© DOCKER COMPOSE (STACK COMPLETE)
# ============================
# docker-compose.yml minimal (API + Prometheus + Grafana + Alertmanager)
# Place ce bloc dans ./docker-compose.yml puis lance : docker compose up --build

# Lance tout le stack :
docker compose up --build -d

# VÃ©rifie :
# - API :        http://localhost:8000/health
# - Metrics :    http://localhost:8000/metrics
# - Prometheus : http://localhost:9090
# - Grafana :    http://localhost:3000 (admin / admin)

# ============================
# ðŸ“ˆ QUERIES RAPIDES (Prometheus/Grafana)
# ============================
# Tape ces expressions dans Prometheus (Graph) ou un panel Grafana (source Prometheus) :
# - Total des prÃ©dictions :
#   prediction_requests_total
# - Temps depuis la derniÃ¨re prÃ©diction :
#   time() - last_prediction_timestamp

# ============================
# ðŸ§ª CI : TEST Dâ€™INTÃ‰GRATION MINIMAL (GitHub Actions)
# ============================
# Fichier .github/workflows/integration.yml
mkdir -p .github/workflows
cat > .github/workflows/integration.yml <<'YAML'
name: Integration Tests
on: [push, pull_request]

jobs: integration
# RÃ´le :
# - Build & dÃ©marre toute la stack dans la CI
# - VÃ©rifie /health et /metrics
# - Stoppe tout (nettoyage)

# ============================
# ðŸ§¯ DÃ‰PANNAGE RAPIDE
# ============================
# Si Prometheus voit â€œvideâ€ : gÃ©nÃ¨re des prÃ©dictions pour alimenter les compteurs
curl -X POST http://127.0.0.1:8000/predict \
  -H "Content-Type: application/json" \
  -d '{"MedInc":12.5,"HouseAge":15,"AveRooms":7,"AveBedrms":1.2,"Population":800,"AveOccup":2.5,"Latitude":37.5,"Longitude":-122.3}'

# Si la CI Ã©choue Ã  /health : augmente le dÃ©lai dâ€™attente (services lents au boot)
# remplace `sleep 20` par `sleep 40` dans integration.yml
