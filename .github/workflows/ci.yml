name: CI/CD - ML Housing API

on:
  push:
    branches: [ "master" ]
  pull_request:
    branches: [ "master" ]

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write

    steps:
      - name: Checkout (with Git LFS)
        uses: actions/checkout@v4
        with:
          lfs: true            # <— récupère les fichiers LFS (modèles .pkl) au lieu des pointeurs
          fetch-depth: 0

      - name: Ensure Git LFS
        run: |
          git lfs version || sudo apt-get update && sudo apt-get install -y git-lfs
          git lfs install
          git lfs pull         # <— ceinture et bretelles : force la récupération LFS

      - name: Show repo content (debug)
        run: |
          ls -la
          ls -la models || true
          file models/* || true

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies (for tests)
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Install package (editable)
        run: pip install -e .

      - name: Run tests (with coverage)
        run: pytest --cov=src --cov-report=term-missing

      
      # Optionnel : échouer si la couverture < 70%
      # - name: Enforce coverage threshold
      #   run: |
      #     coverage=$(pytest --cov=src --cov-report=term | awk '/TOTAL/ {print $4}' | sed 's/%//')
      #     python - <<'PY'
      #     import sys, os
      #     cov = float(os.environ.get("coverage", "0"))
      #     sys.exit(0 if cov >= 70 else 1)
      #     PY
      #   env:
      #     coverage: ${{ steps.tests.outputs.coverage || '0' }}

      # Optionnel : cache buildx
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build Docker image
        run: |
          docker build -t ml-housing-api:ci .
